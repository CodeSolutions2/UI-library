<!DOCTYPE html>
<html>
<head></head>
<body>

<input id="OPENAI_API_KEY" type="text" value="" placeholder="OPENAI_API_KEY" rows="10" cols="100" style="display:block; text-align: left; width: 150px;">
<canvas id="canvas_img" width="224" height="224" style="display:block"></canvas>
  
<button id="run_function" onclick="run_function()">run_function</button>
<button id="try_to_use_nodejs_library_way0" onclick="try_to_use_nodejs_library_way0()">try_to_use_nodejs_library_way0</button>
<button id="try_to_use_nodejs_library_way1" onclick="try_to_use_nodejs_library_way1()">try_to_use_nodejs_library_way1</button>
  
<style>
canvas {border: 1px solid black; position: absolute; display: inline-block; z-index: 0; top: 175px;}
</style>


<!-- Way 0 -->
<script src="https://cdn.jsdelivr.net/npm/@google-cloud/storage@7.14.0/build/cjs/src/index.min.js">var exports = {"__esModule": true};</script>

<!-- Way 1 -->
<script type="module" crossorigin="*" redirect="follow" mode="cors">
import { Storage } from "https://cdn.jsdelivr.net/npm/@google-cloud/storage@7.14.0/build/cjs/src/index.min.js";
module1.Storage = Storage;
var exports = {"__esModule": true};
</script>
  
<script>
	
// --------------------------------------
  
async function try_to_use_nodejs_library_way0() {

  // https://www.npmjs.com/package/@google-cloud/storage
  // https://www.jsdelivr.com/package/npm/@google-cloud/storage

  // Way 0
  var out = _.listBuckets();
  console.log("out: ", out);
  
}

// --------------------------------------

const module1 = {};
  
async function try_to_use_nodejs_library_way1() {

  // https://www.npmjs.com/package/@google-cloud/storage
  // https://www.jsdelivr.com/package/npm/@google-cloud/storage

  // Way 1
  const storage = await module1.Storage();
  console.log("storage: ", storage);
  
  var buckets = await storage.listBuckets();
  console.log("buckets: ", buckets);
}
  
// --------------------------------------
  
async function run_function() {

  // Put a specific image on a canvas.
  await put_an_image_on_a_canvas();

  // ------------------------------
  
  // Transform canvas displayed image into a base64 string.
  var base64_string = await convert_canvas_to_base64str();
  console.log('base64_string: ', );
  
  // ------------------------------
  
}

// --------------------------------------

  

  
// --------------------------------------

var ctx = document.getElementById("canvas_img").getContext("2d");
	
var font_height = 40;
var width = 512;	// default for google_imagen, database
var height = 512;	// default for google_imagen, database
const padding = 4;
  
async function put_an_image_on_a_canvas() {
  
  // Select the topic
  // const motivation_topics = ["health", "education", "lifebalance", "happiness", "success", "effectiveCommunication"];
const motivation_topics = ["health", "lifebalance", "happiness", "success", "effectiveCommunication"];
  const selected_topic = motivation_topics.at(0);
  const neutral_selection = "neutral";

  var cur_date_timestamp = Date.now();
	// console.log("cur_date_timestamp: ", cur_date_timestamp);

	// print the date in correct format
	var cur_date = new Date(cur_date_timestamp).toString();
	// console.log("cur_date: ", cur_date);

  const image_prompt = `Create a neutral image about ${selected_topic}, that is societally acceptable and decent. In addition today's date is ${cur_date}, if there is a major holiday within the next 10 days, use themes from the upcoming holiday to create the image.`;
	
		const text_prompt = `Write a neutral statement about ${selected_topic}. Be creative and give varying responses, limit the response to 25 words or less.`;
  
	// --------------------------------------

  // Select a model for creating an image
  const model_name = 'dall-e-2';
  const image_size = "512x512";
  const image_url = await create_image_call_API_OpenAI(model_name, image_size, image_prompt);
		console.log("image_url: ", image_url);

  // ------------------------------
		
		// Generate automated message for the image
		const generated_text = await create_text_call_API_OpenAI(text_prompt);
		console.log("generated_text: ", generated_text);

  // ------------------------------
  
  const generated_text_array = await preprocess_text(generated_text);
console.log("generated_text_array: ", generated_text_array);

  // ------------------------------
  
		// Display image
		await display_all(generated_text_array, image_url);
		console.log('imageData: ', imageData);
  // ------------------------------
  
}

// --------------------------------------



// ------------------------------------------
// SUBFUNCTIONS
// ------------------------------------------
async function create_image_call_API_OpenAI(model_name, image_size, image_prompt) {

	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + document.getElementById("OPENAI_API_KEY").value}
        var data = {"model": model_name, "prompt": image_prompt, "n": 1, "size": image_size};
	var options = {method : 'POST', headers: headers, body : JSON.stringify(data)};
				
	return await fetch('https://api.openai.com/v1/images/generations', options)
		.then(res => res.json())
		.then(res => { 
			let output = JSON.parse(JSON.stringify(res)); 
			document.getElementById('notification').innerHTML = "Model "+model_name+" and image size "+image_size+" was selected."
			return output["data"][0]["url"];
		})
		.catch(error => { document.getElementById('error').innerHTML = error; });
}

// ------------------------------------------
  
async function create_text_call_API_OpenAI(text_prompt) {

	var headers = {"Content-Type": "application/json", "Authorization": 'Bearer ' + document.getElementById("OPENAI_API_KEY").value};
	
        const model_name = 'gpt-4o-mini'; // 'gpt-3.5-turbo', 'gpt-4-turbo', 'gpt-4o-mini' 
        var system_content = "You are a helpful assistant";
        var assistant_content = "Respond concisely";
        var messages = [{"role": "system", "content": system_content}, {"role": "user", "content": text_prompt}, {"role": "assistant", "content": assistant_content}];
        var data = {"model": model_name, 'messages': messages, 'temperature': 0};
        var url = 'https://api.openai.com/v1/chat/completions';
        var options = {method : 'post', headers: headers, body : JSON.stringify(data)};

        var generated_text = await fetch(url, options)
		.then(res => res.json())
		.then(res => { return JSON.parse(JSON.stringify(res))['choices'][0]['message']['content']; })
		.catch(error => { document.getElementById('error').innerHTML = error; });

	// Replace hypens with spaces
	generated_text = await generated_text.replace(/-/g, " ");
	
	// Replace double hypens with [dot space]
	generated_text = await generated_text.replace(/â€”/g, ". ");

	return generated_text;
}


// ------------------------------------------
  
async function preprocess_text(generated_text) {

	// ------------------------------
	
	// Could adjust this by the length of the generated sentence
	if (width == 256) { font_height = 20; }
	console.log("font_height: ", font_height);

	// ------------------------------
	
	// Measure the max number of [font characters] that can be written on one line
	// Character Width = Font Size * Character Aspect Ratio = 30 * 0.5 = 15pt
	const aspect_ratio = 0.6; // larger aspect_ratio the max_num_of_char_per_line is smaller
	const char_width = font_height*aspect_ratio;
	console.log("char_width: ", char_width);
	
	const max_num_of_char_per_line = await Math.floor(width/char_width);
	console.log("max_num_of_char_per_line: ", max_num_of_char_per_line);

	// ------------------------------
	
	// Separate text into an array for printing line-by-line
	var c = 0;
	var word_list = [];
	var cut_text = [];
	
	generated_text.split(" ").map((word, ind) => {
		c = c + (word.length + 1 + padding); // plus for the space

		if (c > max_num_of_char_per_line){
			cut_text.push(word_list.join(' '));
			word_list = [word];
			c=0;
		} else {
			word_list.push(word);
		}
	});
	cut_text.push(word_list.join(' '));
	console.log('cut_text: ', cut_text);

	return cut_text;
}


// ------------------------------------------
  
async function display_all(generated_text_array, image_url) {
	
	// Make cavas visible
	document.getElementById("canvas_img").style.display = "block";

		// Make an image appear on the canvas
		var image = new Image();
		image.src = image_url;
		image.onload = await function () { 
			// Draw image on canvas
			ctx.drawImage(image, 0,0);
			
      // Put overlay on top of image to make font more readable and image to look more professional
	ctx.fillStyle = "rgb(153 153 153 / 40%)";  // Background square over image = grey
	ctx.fillRect(0, 0, width, height);  // fillRect(x, y, width, height)
      
			write_text(option_text, generated_text_array);
		}
  
}
	
// -----------------------------------------------
	
function write_text(option_text, generated_text_array) {
	
	if (option_text == 'with_text') {
		// Select text contrasting colors to background
		const RGB_contrast = [0, 0, 0];
		// console.log("RGB_contrast: ", RGB_contrast);

		const RGB_opposite_contrast = [225, 225, 225];
	
		const x = 30;
		var y = 50;
		ctx.font = "bold "+font_height.toString()+"px serif";
		ctx.textAlign = "left";
		
		generated_text_array.map((phrase, ind) => {
			// Write text that is filled in
			ctx.fillStyle = "rgb("+RGB_contrast[0]+" "+RGB_contrast[1]+" "+RGB_contrast[2]+")";
			ctx.lineWidth = 1;
			ctx.fillText(phrase, x, y, width);

			// Re-write text outline only, to make text contrasting on the image
			ctx.strokeStyle = "rgb("+RGB_opposite_contrast[0]+" "+RGB_opposite_contrast[1]+" "+RGB_opposite_contrast[2]+")";
			ctx.lineWidth = 1;
			ctx.strokeText(phrase, x, y, width);
			
			y = y + Number(font_height) + padding;
		});

	}
}
	
// -----------------------------------------------

async function convert_canvas_to_base64str() {
	
	// Get canvas image
	const uint8ClampedArray = await ctx.getImageData(0, 0, width, height); // TypedArray  Uint8ClampedArray
	console.log('uint8ClampedArray: ', uint8ClampedArray);

	// Convert TypedArray to normalArray
	const normalArray = await Array.from(uint8ClampedArray.data);
	console.log('normalArray: ', normalArray);
	// length normalArray:  262144
	
	// Convert [normalArray of bytes] to text_characters
	var ASCII_stringArray = normalArray.map((val) => { return String.fromCharCode(val); });
	console.log('ASCII_stringArray: ', ASCII_stringArray);
	// length 262144
	
	// Join all the ASCII characters to form a string
	var ASCII_str = ASCII_stringArray.join('');
	console.log("ASCII_str: ", ASCII_str);
	
	// Put header on base64_string (optional)
	
		
	// Transform ASCII string into a base64 string
	var base64_string = btoa(ASCII_str);
	console.log("base64_string: ", base64_string);

	return base64_string;
}


// -----------------------------------------------

  
  
</script>
</body>
</html>
